<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Badminton Manager Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-border-top { border-top: 4px solid #ef4444; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-900">

    <nav class="bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-50 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <button id="back-btn" onclick="handleBack()" class="hidden p-1 hover:bg-blue-700 rounded-full transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <h1 id="nav-title" class="font-black tracking-tight text-lg uppercase">üè∏ Badminton</h1>
        </div>
        <button id="admin-nav-btn" onclick="goToAdmin()" class="text-[10px] font-black bg-blue-800 px-3 py-1.5 rounded-lg uppercase tracking-widest">Admin</button>
    </nav>

    <div class="container mx-auto p-4 max-w-lg">
        
        <div id="view-home" class="view-section animate-fadeIn">
            <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4">Available Sessions</h2>
            <div id="session-list" class="space-y-3"></div>
        </div>

        <div id="view-detail" class="view-section hidden animate-fadeIn">
            <div id="session-detail-content"></div>
        </div>

        <div id="view-admin" class="view-section hidden animate-fadeIn">
            <div id="admin-auth" class="bg-white p-8 rounded-3xl shadow-xl mt-10">
                <h2 class="text-2xl font-black mb-6">Admin Login</h2>
                <input type="password" id="admin-pass" placeholder="Password" class="w-full bg-gray-100 p-4 rounded-2xl mb-4 outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="verifyAdmin()" class="w-full bg-gray-900 text-white p-4 rounded-2xl font-bold">Access Dashboard</button>
            </div>

            <div id="admin-dashboard" class="hidden space-y-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black">Admin Menu</h2>
                    <button onclick="logoutAdmin()" class="text-red-500 text-[10px] font-black uppercase bg-red-50 px-3 py-2 rounded-lg">Logout</button>
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="showActiveSessions()" class="w-full bg-white border border-gray-100 p-6 rounded-3xl shadow-sm text-left flex justify-between items-center">
                        <div><h3 class="font-black text-gray-800">Manage Active Sessions</h3><p class="text-[10px] text-gray-400 uppercase font-bold">Upcoming games</p></div>
                        <span class="text-blue-600">‚Üí</span>
                    </button>
                    <button onclick="showPastSessions()" class="w-full bg-white border border-gray-100 p-6 rounded-3xl shadow-sm text-left flex justify-between items-center">
                        <div><h3 class="font-black text-gray-800">Manage Past Sessions</h3><p class="text-[10px] text-gray-400 uppercase font-bold">History & Payments</p></div>
                        <span class="text-blue-600">‚Üí</span>
                    </button>
                    <button onclick="showPlayerManager()" class="w-full bg-white border border-gray-100 p-6 rounded-3xl shadow-sm text-left flex justify-between items-center">
                        <div><h3 class="font-black text-gray-800">Manage Player List</h3><p class="text-[10px] text-gray-400 uppercase font-bold">Edit master names</p></div>
                        <span class="text-blue-600">‚Üí</span>
                    </button>
                    <button onclick="showAuditHistory()" class="w-full bg-white border border-gray-100 p-6 rounded-3xl shadow-sm text-left flex justify-between items-center">
                        <div><h3 class="font-black text-gray-800">View Audit History</h3><p class="text-[10px] text-gray-400 uppercase font-bold">System logs</p></div>
                        <span class="text-blue-600">‚Üí</span>
                    </button>
                </div>
            </div>

            <div id="admin-active-list" class="hidden space-y-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-black">Active Sessions</h2>
                    <button onclick="showSessionForm()" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold">+ New</button>
                </div>
                <div id="list-active" class="space-y-3"></div>
            </div>

            <div id="admin-past-list" class="hidden space-y-4">
                <h2 class="text-xl font-black mb-4">Past Sessions</h2>
                <div id="list-past" class="space-y-3"></div>
            </div>

            <div id="admin-player-manager" class="hidden space-y-6">
                <h2 class="text-2xl font-black">Player List</h2>
                <div class="bg-white p-5 rounded-3xl border border-gray-100 shadow-sm space-y-4">
                    <p class="text-[10px] font-black text-gray-400 uppercase">Add New Player</p>
                    <div class="flex gap-2">
                        <input type="text" id="new-player-name" placeholder="Full Name" class="flex-1 bg-gray-50 p-3 rounded-xl border border-gray-100 text-sm outline-none">
                        <button onclick="addMasterPlayer()" class="bg-blue-600 text-white px-5 rounded-xl font-bold text-sm">Add</button>
                    </div>
                </div>
                <div id="master-player-list" class="space-y-2"></div>
            </div>

            <div id="admin-audit-list" class="hidden space-y-4">
                <h2 class="text-xl font-black mb-4">Audit History</h2>
                <div id="list-audit" class="space-y-2 max-h-[500px] overflow-y-auto pr-2"></div>
            </div>

            <div id="admin-editor" class="hidden bg-white p-6 rounded-3xl shadow-xl space-y-4">
                <h2 id="editor-title" class="text-xl font-black">Session Editor</h2>
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 gap-4">
                    <div><label class="text-[10px] font-black text-gray-400 uppercase">Date</label><input type="date" id="f-date" class="w-full bg-gray-50 p-3 rounded-xl border"></div>
                    <div><label class="text-[10px] font-black text-gray-400 uppercase">Time</label><input type="text" id="f-time" class="w-full bg-gray-50 p-3 rounded-xl border"></div>
                    <div><label class="text-[10px] font-black text-gray-400 uppercase">Location</label><input type="text" id="f-loc" class="w-full bg-gray-50 p-3 rounded-xl border"></div>
                    <div class="flex gap-4">
                        <div class="w-1/2"><label class="text-[10px] font-black text-gray-400 uppercase">Capacity</label><input type="number" id="f-cap" class="w-full bg-gray-50 p-3 rounded-xl border"></div>
                        <div class="w-1/2"><label class="text-[10px] font-black text-gray-400 uppercase">Fee</label><input type="text" id="f-fee" class="w-full bg-gray-50 p-3 rounded-xl border"></div>
                    </div>
                </div>
                <div class="flex gap-2 pt-4">
                    <button onclick="closeEditor()" class="w-1/3 bg-gray-100 font-bold p-4 rounded-2xl">Cancel</button>
                    <button onclick="saveSession()" class="w-2/3 bg-blue-600 text-white font-bold p-4 rounded-2xl shadow-lg">Save</button>
                </div>
            </div>

            <div id="admin-player-editor" class="hidden bg-white p-6 rounded-3xl shadow-xl space-y-4">
                <h2 class="text-xl font-black">Edit Player</h2>
                <input type="hidden" id="edit-player-id">
                <div>
                    <label class="text-[10px] font-black text-gray-400 uppercase">Full Name</label>
                    <input type="text" id="edit-player-name" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100">
                </div>
                <div class="flex gap-2 pt-4">
                    <button onclick="showPlayerManager()" class="w-1/3 bg-gray-100 font-bold p-4 rounded-2xl">Cancel</button>
                    <button onclick="savePlayerUpdate()" class="w-2/3 bg-blue-600 text-white font-bold p-4 rounded-2xl shadow-lg">Update Name</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const SB_URL = 'VITE_SUPABASE_URL'; 
    const SB_KEY = 'VITE_SUPABASE_KEY';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let allData = [];
    let masterPlayers = [];
    let currentSessionId = null;
    let isAdmin = localStorage.getItem('isAdmin') === 'true';

    async function logAction(action, details, playerName = null, sessionId = null) {
        try {
            // Validation: session_info is a UUID. 
            // If sessionId is the descriptive string from your previous code, 
            // it must be changed to the actual s.id (the UUID).
            const validSessionId = (sessionId && sessionId.length === 36) ? sessionId : null;

            const { error } = await _supabase.from('audit_logs').insert([{ 
                action: action, 
                details: details, 
                player_name: playerName, 
                session_info: validSessionId // Matches your 'session_info uuid' column
            }]);
            
            if (error) throw error;
        } catch (err) { 
            console.error("Audit Log failed:", err.message); 
        }
    }

    function formatDateWithDay(dateStr) {
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj.getTime())) return dateStr;
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = dateObj.getFullYear();
        const weekday = new Intl.DateTimeFormat('en-GB', { weekday: 'long' }).format(dateObj);
        return `${day}-${month}-${year} (${weekday})`;
    }

    function hideAllViews() {
        document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
        document.getElementById('back-btn').classList.add('hidden');
        document.getElementById('admin-nav-btn').classList.remove('hidden');
    }

    function hideAdminSubpages() {
        ['admin-dashboard', 'admin-active-list', 'admin-past-list', 'admin-player-manager', 'admin-audit-list', 'admin-editor', 'admin-player-editor'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        });
    }

    function handleBack() {
        const subpages = ['admin-active-list', 'admin-past-list', 'admin-player-manager', 'admin-audit-list'];
        const isSubOpen = subpages.some(id => !document.getElementById(id).classList.contains('hidden'));
        
        if (isSubOpen) goToAdmin();
        else if (!document.getElementById('admin-player-editor').classList.contains('hidden')) showPlayerManager();
        else if (!document.getElementById('admin-editor').classList.contains('hidden')) closeEditor();
        else if (!document.getElementById('view-detail').classList.contains('hidden') && isAdmin) goToAdmin();
        else showHome();
    }

    function showHome() {
        hideAllViews();
        document.getElementById('view-home').classList.remove('hidden');
        document.getElementById('nav-title').innerText = "üè∏ Badminton";
        currentSessionId = null;
        renderSessions();
    }

    function goToAdmin() {
        hideAllViews();
        document.getElementById('view-admin').classList.remove('hidden');
        document.getElementById('back-btn').classList.remove('hidden');
        document.getElementById('admin-nav-btn').classList.add('hidden');
        document.getElementById('nav-title').innerText = "Admin Dashboard";
        hideAdminSubpages();
        if (isAdmin) {
            document.getElementById('admin-auth').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
        } else {
            document.getElementById('admin-auth').classList.remove('hidden');
        }
    }

    // --- ADMIN NAVIGATION ---
    function showActiveSessions() { hideAdminSubpages(); document.getElementById('admin-active-list').classList.remove('hidden'); renderAdminLists(); }
    function showPastSessions() { hideAdminSubpages(); document.getElementById('admin-past-list').classList.remove('hidden'); renderAdminLists(); }
    function showPlayerManager() { hideAdminSubpages(); document.getElementById('admin-player-manager').classList.remove('hidden'); renderMasterPlayerList(); }

    async function showAuditHistory() {
        hideAdminSubpages();
        document.getElementById('admin-audit-list').classList.remove('hidden');
        
        // Ordered by your 'created_at' column
        const { data } = await _supabase
            .from('audit_logs')
            .select('*')
            .order('created_at', { ascending: false }) 
            .limit(50);

        document.getElementById('list-audit').innerHTML = (data || []).map(log => `
            <div class="bg-white p-3 rounded-xl border border-gray-50 text-xs mb-2 shadow-sm">
                <div class="flex justify-between mb-1">
                    <span class="font-black text-blue-600 uppercase">${log.action}</span>
                    <span class="text-gray-300">${new Date(log.created_at).toLocaleTimeString()}</span>
                </div>
                <p class="text-gray-600">${log.details}</p>
                ${log.player_name ? `<p class="text-[10px] font-bold text-gray-400 mt-1">Player: ${log.player_name}</p>` : ''}
            </div>`).join('') || '<p class="text-center text-gray-400 italic">No logs found</p>';
    }    

    async function loadData() {
        const { data: sData } = await _supabase.from('sessions').select('*, registrations(*)');
        const { data: pData } = await _supabase.from('players').select('*').order('name');
        masterPlayers = pData || [];
        allData = (sData || []).map(s => ({
            ...s,
            players: s.registrations.filter(r => r.status === 'Confirmed'),
            waitlist: s.registrations.filter(r => r.status === 'Waitlist')
        }));
        renderSessions();
        if (currentSessionId) renderDetailPage();
        if (isAdmin) renderAdminLists();
    }




    function renderSessions() {
    const list = document.getElementById('session-list');
    list.innerHTML = '';
    const today = new Date().setHours(0,0,0,0);
    
    // 1. Filter out past sessions
    // 2. Sort by date (Ascending: closest date first)
    allData
        .filter(s => new Date(s.date).setHours(0,0,0,0) >= today)
        .sort((a, b) => new Date(a.date) - new Date(b.date)) 
        .forEach(s => {
            const spotsLeft = Math.max(0, s.capacity - s.players.length);
            const waitlistCount = s.waitlist ? s.waitlist.length : 0;
            const paidCount = s.players.filter(p => p.payment_status === 'Paid').length;
            
            const card = document.createElement('div');
            card.className = "bg-white p-4 rounded-3xl shadow-sm border border-gray-100 flex items-center gap-4 cursor-pointer hover:shadow-md transition-all active:scale-[0.98] mb-3";
            card.onclick = () => showDetail(s.id);
            
            card.innerHTML = `
                <div class="flex-shrink-0 w-12 h-12 bg-gray-50 rounded-2xl flex items-center justify-center text-xl">
                    üè∏
                </div>
                
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start mb-1">
                        <div>
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">${formatDateWithDay(s.date)}</p>
                            <h3 class="text-lg font-black text-gray-900 leading-tight">${s.time}</h3>
                        </div>
                        <span class="text-[9px] font-black px-2 py-1 rounded-full uppercase ${spotsLeft > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'}">
                            ${spotsLeft > 0 ? spotsLeft + ' Left' : 'Full'}
                        </span>
                    </div>

                    <div class="flex items-center gap-1.5 mb-1">
                        <svg class="w-3 h-3 text-gray-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
                        <p class="text-xs text-gray-400 truncate">${s.location}</p>
                    </div>

                    <div class="flex items-center gap-2 text-[10px] font-bold text-gray-400 uppercase tracking-tight">
                        <span>FEE: <span class="${s.fee.toLowerCase() === 'tbc' ? 'text-yellow-600' : 'text-blue-600'}">${s.fee}</span></span>
                        <span class="text-gray-200">‚Ä¢</span>
                        <span>PLAYERS: <span class="text-gray-600">${s.players.length}/${s.capacity}</span></span>
                        <span class="text-gray-200">‚Ä¢</span>
                        <span>PAID: <span class="text-gray-600">${paidCount}/${s.players.length}</span></span>
                    </div>

                    ${waitlistCount > 0 ? `
                        <div class="mt-2 flex items-center gap-1">
                            <div class="w-1.5 h-1.5 rounded-full bg-orange-400 animate-pulse"></div>
                            <p class="text-[9px] font-black text-orange-500 uppercase">${waitlistCount} on waiting list</p>
                        </div>
                    ` : ''}
                </div>`;
            list.appendChild(card);
        });
}


    function renderSessions_v_0() {
        const list = document.getElementById('session-list');
        list.innerHTML = '';
        const today = new Date().setHours(0,0,0,0);
        
        allData.filter(s => new Date(s.date).setHours(0,0,0,0) >= today).forEach(s => {
            const spotsLeft = Math.max(0, s.capacity - s.players.length);
            const waitlistCount = s.waitlist ? s.waitlist.length : 0;
            const paidCount = s.players.filter(p => p.payment_status === 'Paid').length;
            
            const card = document.createElement('div');
            // Tightened padding and layout for a cleaner look
            card.className = "bg-white p-4 rounded-3xl shadow-sm border border-gray-100 flex items-center gap-4 cursor-pointer hover:shadow-md transition-all active:scale-[0.98] mb-3";
            card.onclick = () => showDetail(s.id);
            
            card.innerHTML = `
                <div class="flex-shrink-0 w-12 h-12 bg-gray-50 rounded-2xl flex items-center justify-center text-xl">
                    üè∏
                </div>
                
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start mb-1">
                        <div>
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">${formatDateWithDay(s.date)}</p>
                            <h3 class="text-lg font-black text-gray-900 leading-tight">${s.time}</h3>
                        </div>
                        <span class="text-[9px] font-black px-2 py-1 rounded-full uppercase ${spotsLeft > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'}">
                            ${spotsLeft > 0 ? spotsLeft + ' Left' : 'Full'}
                        </span>
                    </div>

                    <div class="flex items-center gap-1.5 mb-1">
                        <svg class="w-3 h-3 text-gray-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
                        <p class="text-xs text-gray-400 truncate">${s.location}</p>
                    </div>

                    <div class="flex items-center gap-2 text-[10px] font-bold text-gray-400 uppercase tracking-tight">
                        <span class="flex items-center gap-1">
                            <span>FEE:</span> 
                            <span class="text-blue-600">${s.fee}</span>
                        </span>
                        <span class="text-gray-200">‚Ä¢</span>
                        <span>PLAYERS: <span class="text-blue-600">${s.players.length}/${s.capacity}</span></span>
                        <span class="text-gray-200">‚Ä¢</span>
                        <span>PAID: <span class="text-blue-600">${paidCount}/${s.players.length}</span></span>
                    </div>

                    ${waitlistCount > 0 ? `
                        <div class="mt-2 flex items-center gap-1">
                            <div class="w-1.5 h-1.5 rounded-full bg-orange-400 animate-pulse"></div>
                            <p class="text-[9px] font-black text-orange-500 uppercase">${waitlistCount} on waiting list</p>
                        </div>
                    ` : ''}
                </div>`;
            list.appendChild(card);
        });
    } 

    function renderAdminLists() {
        const activeContainer = document.getElementById('list-active');
        const pastContainer = document.getElementById('list-past');
        const today = new Date().setHours(0,0,0,0);
        if (activeContainer) activeContainer.innerHTML = '';
        if (pastContainer) pastContainer.innerHTML = '';

        allData.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(s => {
            const isPast = new Date(s.date).setHours(0,0,0,0) < today;
            const target = isPast ? pastContainer : activeContainer;
            if (!target) return;
            const paidCount = s.players.filter(p => p.payment_status === 'Paid').length;

            const item = document.createElement('div');
            item.className = "bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex justify-between items-center mb-2";
            item.innerHTML = `
                <div>
                    <p class="text-xs font-bold ${isPast ? 'text-gray-400' : 'text-blue-600'}">${formatDateWithDay(s.date)}</p>
                    <h4 class="font-black text-gray-800">${s.time}</h4>
                    <p class="text-[10px] text-gray-400 font-bold uppercase">${s.location} ‚Ä¢ Fee: ${s.fee} ‚Ä¢ Paid: ${paidCount}/${s.players.length}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="showDetail('${s.id}')" class="bg-blue-50 text-blue-700 font-bold text-[10px] px-3 py-2 rounded-xl">View</button>
                    <button onclick="showSessionForm('${s.id}')" class="bg-gray-50 text-gray-600 font-bold text-[10px] px-3 py-2 rounded-xl">Edit</button>
                    <button onclick="deleteSession('${s.id}')" class="text-red-300 px-2">√ó</button>
                </div>`;
            target.appendChild(item);
        });
    }

    function showDetail(id) {
        currentSessionId = id; hideAllViews();
        document.getElementById('view-detail').classList.remove('hidden');
        document.getElementById('back-btn').classList.remove('hidden');
        renderDetailPage();
    }

function renderDetailPage() {
    const s = allData.find(x => x.id === currentSessionId);
    if (!s) return showHome();

    const pOptions = masterPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    const totalConfirmed = s.players.length;
    const totalPaid = s.players.filter(p => p.payment_status === 'Paid').length;

    // Logic for Dynamic Fee Status
    const isFeeTBC = !s.fee || s.fee.toLowerCase() === 'tbc';
    const feeDisplay = isFeeTBC 
        ? `<span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase">Pending</span>`
        : `<span class="text-blue-600 font-bold">${s.fee}</span>`;

    document.getElementById('session-detail-content').innerHTML = `
        <div class="bg-white rounded-3xl shadow-xl p-6 card-border-top animate-fadeIn">
            <div class="flex justify-between items-start mb-6">
                <div class="space-y-1">
                    <p class="text-xl font-semibold text-gray-800">${formatDateWithDay(s.date)}</p>
                    <p class="text-lg text-gray-600 font-medium">${s.time}</p>
                    <div class="flex items-center gap-1 pt-1">
                        <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <a href="#" class="text-blue-600 hover:underline text-sm font-medium">Venue: ${s.location}</a>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="copyToWhatsApp()" class="p-2 bg-gray-50 rounded-xl hover:bg-gray-100 text-gray-500" title="Copy Link">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    </button>
                    <button onclick="openNativeShare()" class="p-2 bg-gray-50 rounded-xl hover:bg-gray-100 text-gray-500" title="Share">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                    </button>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 mb-8 text-xs font-bold uppercase tracking-wider text-gray-400">
                <div>Fee: ${feeDisplay}</div>
                <div>Players: <span class="text-blue-600">${totalConfirmed}/${s.capacity}</span></div>
                <div>Paid: <span class="text-blue-600">${totalPaid}/${totalConfirmed}</span></div>
            </div>

            <div class="mb-8">
                <div class="flex gap-3">
                    <div class="flex-1 relative">
                        <select id="join-player-id" onchange="toggleJoinButton()" 
                            class="w-full bg-gray-50 rounded-2xl px-5 py-4 outline-none text-sm appearance-none border-2 border-transparent transition-all">
                            <option value="">Choose your name...</option>
                            ${pOptions}
                        </select>
                        <p id="join-error" class="hidden text-red-500 text-[10px] mt-1 ml-2 font-bold">Please select a name to continue.</p>
                    </div>
                    <button id="join-btn" onclick="validateAndJoin()" 
                        class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black uppercase opacity-50 cursor-not-allowed transition-all hover:bg-blue-700">
                        Join
                    </button>
                </div>
            </div>

            <div class="space-y-1">
                <p class="text-[10px] font-black text-gray-400 uppercase mb-3">Participants</p>
                ${s.players.map(p => `
                    <div class="group flex justify-between items-center p-3 rounded-xl hover:bg-gray-50 transition-colors border border-transparent">
                        <span class="font-semibold text-gray-700">${p.player_name}</span>
                        <div class="flex items-center gap-4">
                            <button onclick="handlePayment('${p.id}', '${p.payment_status}')" 
                                class="text-[10px] px-3 py-1 rounded-full font-bold ${p.payment_status === 'Paid' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-400'}">
                                ${p.payment_status === 'Paid' ? 'PAID' : 'PAY'}
                            </button>
                            <button onclick="handleRemoval('${p.id}', '${s.id}', '${p.player_name}')" 
                                class="text-red-300 hover:text-red-600 transition-colors pl-4 border-l border-gray-100">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                `).join('')}
                
                ${s.waitlist.length > 0 ? `
                    <p class="text-[10px] font-black text-gray-400 uppercase pt-6 mb-3">Waitlist</p>
                    ${s.waitlist.map(p => `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl italic">
                            <span class="text-gray-500 text-sm">${p.player_name}</span>
                            <button onclick="handleRemoval('${p.id}', '${s.id}', '${p.player_name}')" 
                                class="text-red-200 hover:text-red-400 transition-colors pl-4 border-l border-gray-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    `).join('')}
                ` : ''}
            </div>
        </div>`;
}









    // --- WHATSAPP LOGIC ---
    function copyToWhatsApp() {
        const s = allData.find(x => x.id === currentSessionId);
        if (!s) return;
        const pList = s.players.map((p, i) => `${i + 1}. ${p.player_name}${p.payment_status === 'Paid' ? ' *Paid*' : ''}`).join('\n');
        const wList = s.waitlist.length > 0 ? `\n\n*Waitlist:*\n${s.waitlist.map((p, i) => `W${i+1}. ${p.player_name}`).join('\n')}` : '';
        const msg = `üè∏ *BADMINTON*\nüìÖ *Date:* ${formatDateWithDay(s.date)}\n‚è∞ *Time:* ${s.time}\nüìç *Loc:* ${s.location}\nüí∞ *Fee:* ${s.fee}\n\n*Confirmed:*\n${pList || '_None_'}${wList}`;
        navigator.clipboard.writeText(msg).then(() => Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Copied to clipboard!', showConfirmButton: false, timer: 1500 }));
    }

    // --- MASTER PLAYER MGMT ---
    function renderMasterPlayerList() {
        document.getElementById('master-player-list').innerHTML = masterPlayers.map(p => `
            <div class="bg-white p-4 rounded-2xl border border-gray-100 flex justify-between items-center shadow-sm mb-2">
                <span class="font-bold text-gray-700">${p.name}</span>
                <div class="flex gap-2">
                    <button onclick="editPlayerForm(${p.id}, '${p.name}')" class="text-xs bg-gray-50 text-gray-600 px-3 py-1 rounded-lg font-bold uppercase">Edit</button>
                    <button onclick="deleteMasterPlayer(${p.id}, '${p.name}')" class="text-red-300 px-2">√ó</button>
                </div>
            </div>`).join('') || '<p class="text-center text-gray-400 italic">No players added yet.</p>';
    }

    async function addMasterPlayer() {
        const nameInput = document.getElementById('new-player-name');
        const name = nameInput.value.trim();
        if (!name) return;
        await _supabase.from('players').insert([{ name }]);
        nameInput.value = '';
        await logAction('ADMIN_PLAYER_CREATED', `Added ${name} to master list`);
        loadData();
    }

    function editPlayerForm(id, name) { hideAdminSubpages(); document.getElementById('admin-player-editor').classList.remove('hidden'); document.getElementById('edit-player-id').value = id; document.getElementById('edit-player-name').value = name; }

    async function savePlayerUpdate() {
        const id = document.getElementById('edit-player-id').value;
        const newName = document.getElementById('edit-player-name').value.trim();
        if (!newName) return;
        await _supabase.from('players').update({ name: newName }).eq('id', id);
        await _supabase.from('registrations').update({ player_name: newName }).eq('player_id', id);
        await logAction('ADMIN_PLAYER_UPDATED', `Changed name to ${newName}`);
        showPlayerManager(); loadData();
    }

    async function deleteMasterPlayer(id, name) {
        const { isConfirmed } = await Swal.fire({ title: 'Remove?', text: name, icon: 'warning', showCancelButton: true });
        if (isConfirmed) { await _supabase.from('players').delete().eq('id', id); await logAction('ADMIN_PLAYER_DELETED', `Deleted ${name}`); loadData(); }
    }

    // --- SESSION OPS ---
    async function joinSession_Delete() {
        const playerId = document.getElementById('join-player-id').value;
        if (!playerId) return;
        const player = masterPlayers.find(p => p.id == playerId);
        const s = allData.find(x => x.id === currentSessionId);
        if (s.registrations.some(r => r.player_id == playerId)) return Swal.fire('Error', 'Player name is already registered', 'error');
        const status = s.players.length >= s.capacity ? 'Waitlist' : 'Confirmed';
        await _supabase.from('registrations').insert([{ session_id: currentSessionId, player_id: playerId, player_name: player.name, status: status }]);
        await logAction('PLAYER_REGISTERED', `${player.name} joined as ${status} for session on ${session.date} (${session.time})`, player.name, currentSessionId);
        loadData();
    }


    async function joinSession() {
        const playerId = document.getElementById('join-player-id').value;
        const player = masterPlayers.find(p => p.id == playerId);
        const session = allData.find(s => s.id === currentSessionId);

        if (!player || !session) return;

        // Determine status based on capacity
        const status = session.players.length < session.capacity ? 'Confirmed' : 'Waitlist';

        const { error } = await _supabase.from('registrations').insert([{
            session_info: session.id,
            player_id: player.id,
            player_name: player.name,
            status: status,
            payment_status: 'Unpaid'
        }]);

        if (!error) {
            // Log the action with specific session details
            await logAction(
                'PLAYER_REGISTERED', 
                `${player.name} joined as ${status} for session on ${session.date} (${session.time})`, 
                player.name, 
                session.id
            );

            // Improved Success Message
            Swal.fire({
                title: status === 'Confirmed' ? 'Booking Confirmed!' : 'Added to Waitlist',
                html: `
                    <div class="text-left bg-gray-50 p-4 rounded-2xl mt-2 text-sm">
                        <p class="mb-1"><strong>Player:</strong> ${player.name}</p>
                        <p class="mb-1"><strong>Session:</strong> ${session.time}</p>
                        <p class="mb-1"><strong>Date:</strong> ${formatDateWithDay(session.date)}</p>
                        <p><strong>Venue:</strong> ${session.location}</p>
                    </div>
                    <p class="mt-4 text-xs text-gray-400 font-bold uppercase tracking-widest">See you on the court!</p>
                `,
                icon: 'success',
                confirmButtonText: 'Great!',
                confirmButtonColor: '#2563eb',
                customClass: {
                    popup: 'rounded-3xl',
                    confirmButton: 'rounded-xl px-8 py-3 uppercase font-black text-xs'
                }
            });

            loadData();
        } else {
            Swal.fire('Error', 'You might already be registered for this session.', 'error');
        }
    }




        // Handles "Join" button state
    function toggleJoinButton() {
        const select = document.getElementById('join-player-id');
        const btn = document.getElementById('join-btn');
        const errorMsg = document.getElementById('join-error');
        
        if (select.value) {
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.disabled = false;
            select.classList.remove('border-red-500');
            errorMsg.classList.add('hidden');
        } else {
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.disabled = true;
        }
    }

    // Validation logic for "Join" click
    function validateAndJoin() {
        const select = document.getElementById('join-player-id');
        if (!select.value) {
            select.classList.add('border-red-500', 'animate-pulse');
            document.getElementById('join-error').classList.remove('hidden');
            setTimeout(() => select.classList.remove('animate-pulse'), 500);
            return;
        }
        joinSession();
    }

    // Native Mobile Share Sheet
    function openNativeShare() {
        const s = allData.find(x => x.id === currentSessionId);
        const directLink = `${window.location.origin}${window.location.pathname}?session=${s.id}`;

        if (navigator.share) {
            navigator.share({
                title: 'Join my Badminton Session!',
                text: `Click here to join the session on ${formatDateWithDay(s.date)}:`,
                url: directLink
            }).catch(console.error);
        } else {
            // Fallback: Copy the direct link to clipboard
            navigator.clipboard.writeText(directLink);
            Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Link copied!', showConfirmButton: false, timer: 1500 });
        }
    }


    async function handlePayment(id, currentStatus) {
        const newStatus = currentStatus === 'Paid' ? 'Unpaid' : 'Paid';
        
        // 1. Find the registration and session details for the log
        const session = allData.find(s => s.registrations.some(r => r.id == id));
        const reg = session.registrations.find(r => r.id == id);
        
        // 2. Update the database
        const { error } = await _supabase.from('registrations')
            .update({ payment_status: newStatus })
            .eq('id', id);

        if (!error) {
            // 3. Add an entry to the audit table
            const action = newStatus === 'Paid' ? 'PLAYER_PAID' : 'PLAYER_UNPAID';
            const detailMsg = `${reg.player_name} marked as ${newStatus} for session on ${session.date}`;
            
            await logAction(action, detailMsg, reg.player_name, session.id);
            
            // 4. Refresh the UI
            loadData();
        } else {
            Swal.fire('Error', 'Could not update payment status', 'error');
        }
    }    


    async function handleRemoval_Old(regId, sid, name) {
        const result = await Swal.fire({ title: 'Remove?', text: name, icon: 'warning', showCancelButton: true });
        if (result.isConfirmed) { await _supabase.from('registrations').delete().eq('id', regId); loadData(); }
    }

    async function handleRemoval(regId, sid, name) {
        const result = await Swal.fire({ 
            title: 'Remove Player?', 
            text: `Are you sure you want to remove ${name}?`, 
            icon: 'warning', 
            showCancelButton: true
        });

        if (result.isConfirmed) {
            // Find the session object to extract details
            const session = allData.find(s => s.id === sid);
            
            // Construct a rich detail message
            const logDetails = session 
                ? `Removed ${name} from session on ${session.date} (${session.time}) at ${session.location}`
                : `Removed ${name} from session ID: ${sid}`;

            const { error } = await _supabase.from('registrations').delete().eq('id', regId);

            if (!error) {
                // Log with the rich detail message
                await logAction('PLAYER_REMOVED', logDetails, name, sid);
                loadData();

                                Swal.fire({
                    toast: true,
                    position: 'top',
                    icon: 'success',
                    title: 'Player removed',
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        }
    }

    

    function verifyAdmin() { if (document.getElementById('admin-pass').value === 'admin123') { isAdmin = true; localStorage.setItem('isAdmin', 'true'); goToAdmin(); } }
    function logoutAdmin() { isAdmin = false; localStorage.removeItem('isAdmin'); location.reload(); }

    function showSessionForm(id = null) {
        hideAdminSubpages(); document.getElementById('admin-editor').classList.remove('hidden');
        if (id) {
            const s = allData.find(x => x.id === id);
            document.getElementById('edit-id').value = s.id;
            document.getElementById('f-date').value = s.date;
            document.getElementById('f-time').value = s.time;
            document.getElementById('f-loc').value = s.location;
            document.getElementById('f-cap').value = s.capacity;
            document.getElementById('f-fee').value = s.fee;
        } else {
            document.getElementById('edit-id').value = "";
            ['f-date', 'f-time', 'f-loc', 'f-cap', 'f-fee'].forEach(i => document.getElementById(i).value = "");
        }
    }

    function closeEditor() { hideAdminSubpages(); document.getElementById('admin-active-list').classList.remove('hidden'); }

    async function saveSession() {
        const sessionId = document.getElementById('edit-id').value;
        const sData = { date: document.getElementById('f-date').value, time: document.getElementById('f-time').value, location: document.getElementById('f-loc').value, capacity: parseInt(document.getElementById('f-cap').value), fee: document.getElementById('f-fee').value };
        if (sessionId) await _supabase.from('sessions').update(sData).eq('id', sessionId);
        else await _supabase.from('sessions').insert([sData]);
        showActiveSessions(); loadData();
    }

    async function deleteSession(id) {
        const { isConfirmed } = await Swal.fire({ title: 'Delete?', icon: 'warning', showCancelButton: true });
        if (isConfirmed) { await _supabase.from('sessions').delete().eq('id', id); loadData(); }
    }

    window.onload = async () => {
        await loadData(); // Load all data first
        
        // Check if there is a session ID in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');
        
        if (sessionId) {
            // If found, automatically trigger the detail view for that session
            showDetail(sessionId);
        }
    };


</script>
</body>
</html>
